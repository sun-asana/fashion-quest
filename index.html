<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            /* –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–æ–∑–æ–≤—ã–π), –µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–ª –¥—Ä—É–≥–æ–π */
            --accent-color: #ff4081; 
        }

        .game-container { display: flex; align-items: flex-start; gap: 20px; justify-content: center; padding: 10px; }
        
        /* –†–∞–º–∫–∞ –∫—É–∫–ª—ã —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã–±–æ—Ä–∞ —É—á–∏—Ç–µ–ª—è */
        #character-preview { 
            flex-shrink: 0; 
            background: #fff; 
            border-radius: 20px; 
            border: 3px solid var(--accent-color); 
            position: relative; 
            width: 220px; 
            height: 380px; 
            transition: border-color 0.3s;
        }

        .shop-content { flex-grow: 1; max-height: 380px; overflow-y: auto; }
        
        /* –¢–∞–π–º–µ—Ä —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –∫—Ä–∞—Å–∏—Ç—Å—è */
        #timer-display { 
            font-size: 24px; 
            font-weight: bold; 
            color: var(--accent-color); 
            text-align: center; 
            margin-bottom: 10px; 
        }
        .timer-low { color: #ff0000 !important; animation: blink 0.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .shop-item { background: #f9f9f9; margin-bottom: 8px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent-color); }
        .price-tag { font-size: 0.9rem; font-weight: bold; color: var(--accent-color); }
        
        .shining { animation: shine 0.8s ease-in-out; }
        @keyframes shine { 0% { filter: brightness(1); } 50% { filter: brightness(1.4) drop-shadow(0 0 20px gold); } 100% { filter: brightness(1); } }

        /* –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –û–ö */
        #modal-btn {
            margin-top: 15px; 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 25px; 
            width: 100%; 
            cursor: pointer; 
            font-weight: bold;
            transition: 0.3s;
        }
        #modal-btn:hover { filter: brightness(0.9); }
    </style>
</head>
<body>
    <audio id="sound-coin" src="https://www.soundjay.com/misc/sounds/coins-spilled-1.mp3"></audio>

    <div id="balance-container" class="fq-balance-widget">
        <div class="fq-coin"></div>
        <span id="balance-val">0</span>
    </div>

    <div id="fq-overlay" class="hidden">
        <div id="fq-modal" style="max-width: 750px; width: 95%;">
            <div id="timer-display"></div>
            <h2 id="modal-title" style="color: var(--accent-color); margin-top: 0; text-align: center;"></h2>
            
            <div class="game-container">
                <div id="character-preview">
                    <img id="base-body" src="assets/body/girl.png" style="position: absolute; width: 100%; z-index: 1;">
                    <img id="layer-bottom" src="" style="position: absolute; width: 100%; z-index: 2;">
                    <img id="layer-top" src="" style="position: absolute; width: 100%; z-index: 3;">
                    <img id="layer-shoes" src="" style="position: absolute; width: 100%; z-index: 4;">
                    <img id="layer-acc" src="" style="position: absolute; width: 100%; z-index: 5;">
                </div>
                <div id="modal-content" class="shop-content"></div>
            </div>

            <button id="modal-btn">–û–ö</button>
        </div>
    </div>

    <script src="engine.js"></script>
    <script>
        let timeLeft = 0;
        let timerId = null;
        let currentReward = 0;

        function refreshBalance() { document.getElementById('balance-val').innerText = window.FQ.money; }
        window.onload = refreshBalance;

        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–Ω–æ–ø–∫–∏ Genially
        window.addEventListener('message', function(event) {
            if (event.data.type === 'openTask') {
                // –ü–†–ò–ú–ï–ù–Ø–ï–ú –¶–í–ï–¢ –£–ß–ò–¢–ï–õ–Ø
                if(event.data.themeColor) {
                    document.documentElement.style.setProperty('--accent-color', event.data.themeColor);
                }
                startTask(event.data);
            }
        });

        function startTask(data) {
            const timerDisplay = document.getElementById('timer-display');
            timeLeft = data.time;
            currentReward = 200; // –ú–∞–∫—Å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å
            
            timerDisplay.innerText = `–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ${timeLeft} —Å–µ–∫`;
            timerDisplay.classList.remove('timer-low');
            timerDisplay.style.display = 'block';

            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = `–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ${timeLeft} —Å–µ–∫`;
                if(timeLeft <= 10) timerDisplay.classList.add('timer-low');
                if(timeLeft <= 0) {
                    clearInterval(timerId);
                    timerDisplay.innerText = "–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ù–∞–≥—Ä–∞–¥–∞ —Å–Ω–∏–∂–µ–Ω–∞.";
                    currentReward = 100;
                }
            }, 1000);

            openTaskUI(data);
        }

        function openTaskUI(data) {
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('modal-btn');
            
            title.innerText = "–ó–∞–¥–∞–Ω–∏–µ";
            document.getElementById('character-preview').style.display = 'none';
            
            let imgHtml = data.img ? `<img src="${data.img}" style="max-width:100%; display:block; margin: 0 auto 10px; border-radius:10px;">` : '';
            content.innerHTML = `
                ${imgHtml}
                <p style="text-align:center; color: #333;">${data.q}</p>
                <input type="text" id="user-answer" style="width:100%; padding:10px; border-radius:10px; border:2px solid var(--accent-color); text-align:center;" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç...">
            `;
            
            document.getElementById('fq-overlay').classList.remove('hidden');
            btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
            
            btn.onclick = () => {
                const ans = document.getElementById('user-answer').value;
                if(ans.toLowerCase().trim() === data.a.toLowerCase().trim()) {
                    clearInterval(timerId);
                    window.FQ.addMoney(currentReward);
                    refreshBalance();
                    openShop(data.shopType);
                } else {
                    alert("–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.");
                }
            };
        }

        function openShop(filterType) {
            document.getElementById('timer-display').style.display = 'none';
            document.getElementById('character-preview').style.display = 'block';
            document.getElementById('modal-title').innerText = "–í—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É";
            
            const allItems = [
                {id: 'top_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –æ–¥–µ–∂–¥–∞', price: 200, type: 'top'},
                {id: 'top_2', name: 'üëï –ü—Ä–æ—Å—Ç–∞—è –æ–¥–µ–∂–¥–∞', price: 100, type: 'top'},
                {id: 'bottom_1', name: 'üíé –ë—Ä–µ–Ω–¥–æ–≤—ã–π –Ω–∏–∑', price: 200, type: 'bottom'},
                {id: 'bottom_2', name: 'ü©≥ –û–±—ã—á–Ω—ã–π –Ω–∏–∑', price: 100, type: 'bottom'},
                {id: 'shoes_1', name: 'üíé –ó–æ–ª–æ—Ç–∞—è –æ–±—É–≤—å', price: 200, type: 'shoes'},
                {id: 'shoes_2', name: 'üëü –¢–∞–ø–æ—á–∫–∏', price: 100, type: 'shoes'},
                {id: 'acc_1', name: 'üíé –¢–æ–ø–æ–≤—ã–µ –æ—á–∫–∏', price: 200, type: 'acc'},
                {id: 'acc_2', name: 'üï∂ –ü—Ä–æ—Å—Ç—ã–µ –æ—á–∫–∏', price: 100, type: 'acc'}
            ];

            const items = allItems.filter(i => i.type === filterType);
            let html = `<div>`;
            items.forEach(item => {
                const isBought = window.FQ.inventory.includes(item.id);
                html += `
                    <div class="shop-item">
                        <span>${item.name}<br><span class="price-tag">${item.price} üí∞</span></span>
                        <button onclick="tryOn('${item.id}', ${item.price}, '${item.type}')" 
                                style="background:${isBought?'#4CAF50':'var(--accent-color)'}; color:white; border:none; padding:8px 15px; border-radius:10px; cursor:pointer; font-weight:bold;">
                            ${isBought ? '–ù–∞–¥–µ—Ç–æ' : '–ö—É–ø–∏—Ç—å'}
                        </button>
                    </div>`;
            });
            html += `</div>`;
            
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-btn').innerText = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–≤–µ—Å—Ç";
            document.getElementById('modal-btn').onclick = () => {
                document.getElementById('fq-overlay').classList.add('hidden');
                window.parent.postMessage({type: 'close'}, '*');
            };
        }

        function tryOn(id, price, type) {
            if (window.FQ.inventory.includes(id)) {
                apply(id, type);
            } else if (window.FQ.buyItem(id, price)) {
                document.getElementById('sound-coin').play();
                refreshBalance();
                apply(id, type);
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–ª–∞ –∑–µ–ª–µ–Ω–æ–π
                openShop(type);
            } else {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è —ç–ª–∏—Ç–Ω–æ–π –≤–µ—â–∏!");
            }
        }

        function apply(id, type) {
            document.getElementById('layer-' + type).src = `assets/clothes/${type}/${id}.png`;
            const cp = document.getElementById('character-preview');
            cp.classList.add('shining');
            setTimeout(() => cp.classList.remove('shining'), 800);
        }
    </script>
</body>
</html>
