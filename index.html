<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --accent-color: #4a69bd; 
        }

        #fq-modal {
            max-width: 800px !important;
            width: 95% !important;
            padding: 30px !important;
            border-radius: 24px !important;
            background: white !important;
            border: none !important;
            position: relative; /* –ß—Ç–æ–±—ã —Ç–æ—Å—Ç –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
        }

        .game-container { 
            display: flex; 
            align-items: center; 
            gap: 30px; 
            justify-content: center; 
            padding: 10px;
            min-height: 420px;
        }
        
        #character-preview { 
            flex-shrink: 0; 
            background: #fdfdfd; 
            border-radius: 20px; 
            border: 2px solid var(--accent-color); 
            position: relative; 
            width: 250px; 
            height: 400px; 
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
        }

        .char-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #modal-content { 
            flex-grow: 1; 
            max-height: 400px; 
            overflow-y: auto; 
            padding-right: 10px;
        }
        
        #timer-display { 
            font-size: 20px; 
            font-weight: bold; 
            color: var(--accent-color); 
            text-align: center; 
            margin-bottom: 15px;
            font-family: sans-serif;
        }

        .shop-item { 
            background: #f8f9fa; 
            margin-bottom: 12px; 
            padding: 15px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid var(--accent-color);
        }
        
        .price-tag { font-weight: bold; color: var(--accent-color); font-size: 14px; }

        #modal-btn {
            margin-top: 20px; 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 50px; 
            width: 100%; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 16px;
        }

        .shining { animation: shine 0.8s ease-in-out; }
        @keyframes shine { 
            0% { filter: brightness(1); } 
            50% { filter: brightness(1.2) drop-shadow(0 0 10px var(--accent-color)); } 
            100% { filter: brightness(1); } 
        }

        /* –ö—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–æ–Ω–µ—Ç */
        #error-toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            font-family: sans-serif;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        #error-toast.show { opacity: 1; top: 40px; }
        /* –ü—Ä—è—á–µ–º –∑–Ω–∞—á–æ–∫ –±–∏—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø–æ–∫–∞ –≤–µ—â—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ */
        .char-layer[src=""], .char-layer:not([src]) {
            display: none;
        }
    </style>
</head>
<body>
    <div id="error-toast">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!</div>

    <audio id="sound-coin" src="https://www.soundjay.com/misc/sounds/coins-spilled-1.mp3"></audio>

    <div id="balance-container" class="fq-balance-widget">
        <div class="fq-coin"></div>
        <span id="balance-val">0</span>
    </div>

    <div id="fq-overlay" class="hidden">
        <div id="fq-modal">
            <div id="timer-display"></div>
            <h2 id="modal-title" style="color: var(--accent-color); text-align: center; font-family: sans-serif; margin-bottom: 20px;"></h2>
            
            <div class="game-container">
                <div id="character-preview">
                    <img id="base-body" src="assets/body/girl.png" class="char-layer" style="z-index: 1;">
                    <img id="layer-bottom" src="" class="char-layer" style="z-index: 2;">
                    <img id="layer-top" src="" class="char-layer" style="z-index: 3;">
                    <img id="layer-shoes" src="" class="char-layer" style="z-index: 4;">
                    <img id="layer-acc" src="" class="char-layer" style="z-index: 5;">
                    <img id="layer-hat" src="" class="char-layer" style="z-index: 6;">
                </div>
                <div id="modal-content"></div>
            </div>

            <button id="modal-btn">–û–ö</button>
        </div>
    </div>

    <script src="engine.js"></script>
    <script>
        let timeLeft = 0;
        let timerId = null;
        let currentReward = 0;

        function refreshBalance() { 
            document.getElementById('balance-val').innerText = window.FQ.money; 
        }

window.onload = function() {
    // 1. –î–µ–Ω—å–≥–∏ –≤—Å–µ–≥–¥–∞ 0 –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–ª–∞–π–¥–∞
    window.FQ.money = 0; 

    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–∑ –ø–∞–º—è—Ç–∏
    const savedInventory = localStorage.getItem('fq_inventory');
    window.FQ.inventory = savedInventory ? JSON.parse(savedInventory) : [];
    
    // 3. –ñ–¥–µ–º 50–º—Å, —á—Ç–æ–±—ã DOM –ø—Ä–æ—Å–Ω—É–ª—Å—è, –∏ –Ω–∞–¥–µ–≤–∞–µ–º –≤–µ—â–∏
    setTimeout(() => {
        window.FQ.inventory.forEach(itemId => {
            const type = itemId.split('_')[0];
            apply(itemId, type);
        });
    }, 50);

    refreshBalance();
};

        window.addEventListener('message', function(event) {
            if (event.data.type === 'openTask') {
                if(event.data.themeColor) {
                    document.documentElement.style.setProperty('--accent-color', event.data.themeColor);
                }
                startTask(event.data);
            }
        });

        function startTask(data) {
            timeLeft = data.time;
            currentReward = 200;
            const td = document.getElementById('timer-display');
            td.style.display = 'block';
            td.innerText = `‚è≥ –í—Ä–µ–º—è: ${timeLeft} —Å–µ–∫`;

            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                td.innerText = `‚è≥ –í—Ä–µ–º—è: ${timeLeft} —Å–µ–∫`;
                if(timeLeft <= 0) {
                    clearInterval(timerId);
                    td.innerText = "‚åõ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ù–∞–≥—Ä–∞–¥–∞ —Å–Ω–∏–∂–µ–Ω–∞.";
                    currentReward = 100;
                }
            }, 1000);

            openTaskUI(data);
        }

        function openTaskUI(data) {
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('modal-btn');
            
            title.innerText = "–ó–∞–¥–∞–Ω–∏–µ";
            document.getElementById('character-preview').style.display = 'none';
            
            let imgHtml = data.img ? `<img src="${data.img}" style="max-width:100%; max-height:250px; display:block; margin: 0 auto 15px; border-radius:15px;">` : '';
            content.innerHTML = `
                ${imgHtml}
                <p style="text-align:center; font-size: 18px; color: #444; font-family: sans-serif;">${data.q}</p>
                <input type="text" id="user-answer" style="width:100%; padding:15px; border-radius:12px; border:2px solid var(--accent-color); text-align:center; font-size: 18px;" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
            `;
            
            document.getElementById('fq-overlay').classList.remove('hidden');
            btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç";
            
         btn.onclick = () => {
                const ans = document.getElementById('user-answer').value;
                if(ans && ans.toLowerCase().trim() === data.a.toLowerCase().trim()) {
                    clearInterval(timerId);
                    window.FQ.addMoney(currentReward);
                    refreshBalance();
                    openShop(data.shopType);
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –∫—Ä–∞—Å–∏–≤—ã–π —Ç–æ—Å—Ç –≤–º–µ—Å—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–ª–µ—Ä—Ç–∞
                    showError("–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.");
                }
            };
        }

function openShop(filterType) {
            // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏
            document.getElementById('timer-display').style.display = 'none';
            document.getElementById('character-preview').style.display = 'block';
            
            const typeNames = {
                'top': '–í–µ—Ä—Ö–Ω—è—è –æ–¥–µ–∂–¥–∞',
                'bottom': '–ù–∏–∑',
                'shoes': '–û–±—É–≤—å',
                'hat': '–ì–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä',
                'acc': '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã'
            };
            document.getElementById('modal-title').innerText = typeNames[filterType] || "–ú–∞–≥–∞–∑–∏–Ω";
            
            // 2. –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–û–ï –û–î–ï–í–ê–ù–ò–ï:
            // –ë–µ—Ä–µ–º –≤—Å—ë, —á—Ç–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, –∏ –Ω–∞–¥–µ–≤–∞–µ–º –Ω–∞ –∫—É–∫–ª—É
            window.FQ.inventory.forEach(itemId => {
                const type = itemId.split('_')[0]; // –∏–∑ 'top_1' –ø–æ–ª—É—á–∏–º 'top'
                apply(itemId, type); 
            });

            // 3. –¢–≤–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            const allItems = [
                {id: 'top_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –≤–µ—â—å', price: 200, type: 'top'},
                {id: 'top_2', name: 'üëï –ë–∞–∑–æ–≤–∞—è –≤–µ—â—å', price: 100, type: 'top'},
                {id: 'bottom_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –≤–µ—â—å', price: 200, type: 'bottom'},
                {id: 'bottom_2', name: 'ü©≥ –ë–∞–∑–æ–≤–∞—è –≤–µ—â—å', price: 100, type: 'bottom'},
                {id: 'shoes_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –≤–µ—â—å', price: 200, type: 'shoes'},
                {id: 'shoes_2', name: 'üëü –ë–∞–∑–æ–≤–∞—è –≤–µ—â—å', price: 100, type: 'shoes'},
                {id: 'hat_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –≤–µ—â—å', price: 200, type: 'hat'},
                {id: 'hat_2', name: 'üß¢ –ë–∞–∑–æ–≤–∞—è –≤–µ—â—å', price: 100, type: 'hat'},
                {id: 'acc_1', name: 'üíé –≠–ª–∏—Ç–Ω–∞—è –≤–µ—â—å', price: 200, type: 'acc'},
                {id: 'acc_2', name: 'üëì –ë–∞–∑–æ–≤–∞—è –≤–µ—â—å', price: 100, type: 'acc'}
            ];

            const items = allItems.filter(i => i.type === filterType);
            let html = `<div>`;
            items.forEach(item => {
                const isBought = window.FQ.inventory.includes(item.id);
                html += `
                    <div class="shop-item">
                        <span style="font-family: sans-serif;"><b>${item.name}</b><br><span class="price-tag">${item.price} üí∞</span></span>
                        <button onclick="tryOn('${item.id}', ${item.price}, '${item.type}')" 
                                style="background:${isBought?'#27ae60':'var(--accent-color)'}; color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:bold;">
                            ${isBought ? '–ù–∞–¥–µ—Ç–æ' : '–ö—É–ø–∏—Ç—å'}
                        </button>
                    </div>`;
            });
            html += `</div>`;
            
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-btn').innerText = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å ‚ú®";
            document.getElementById('modal-btn').onclick = () => {
                document.getElementById('fq-overlay').classList.add('hidden');
                window.parent.postMessage({type: 'close'}, '*');
            };
        }

        // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ –∫—Ä–∞—Å–∏–≤–æ–π –æ—à–∏–±–∫–∏
        function showError(text) {
            const toast = document.getElementById('error-toast');
            toast.innerText = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫—É–ø–∫–∏
        function tryOn(id, price, type) {
            if (window.FQ.inventory.includes(id)) {
                apply(id, type);
                openShop(type);
            } else if (window.FQ.buyItem(id, price)) {
                document.getElementById('sound-coin').play();
                refreshBalance();
                apply(id, type);
                openShop(type);
            } else {
                // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à–µ –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ alert
                showError("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!");
            }
        }

        function apply(id, type) {
            console.log("–ü—ã—Ç–∞—é—Å—å –Ω–∞–¥–µ—Ç—å:", id, "–Ω–∞ —Å–ª–æ–π:", type); // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
            
            const img = document.getElementById('layer-' + type);
            if (img) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –≤ –∫–æ–Ω–µ—Ü –ø—É—Ç–∏, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±—Ä–∞–ª —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –∫–µ—à–∞
                const cacheBuster = "?" + new Date().getTime();
                img.src = `assets/clothes/${type}/${id}.png` + cacheBuster;
                
                // –°–Ω–∏–º–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
                img.style.display = 'block'; 
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å, –≤—ã–≤–µ–¥–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
                img.onerror = () => console.error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: " + img.src);
            } else {
                console.error("–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å ID: layer-" + type);
            }
            
            const cp = document.getElementById('character-preview');
            if (cp) {
                cp.classList.add('shining');
                setTimeout(() => cp.classList.remove('shining'), 800);
            }
        }
    </script>
</body>
</html>
