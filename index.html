<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã */
        .game-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            justify-content: center;
            padding: 10px;
        }
        
        /* –û–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        #character-preview {
            flex-shrink: 0;
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #ff4081;
            position: relative;
            width: 220px;
            height: 380px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        /* –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ */
        .shop-content {
            flex-grow: 1;
            max-height: 380px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–∏—è–Ω–∏—è –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ/–ø—Ä–∏–º–µ—Ä–∫–µ */
        @keyframes shine {
            0% { filter: brightness(1) drop-shadow(0 0 0px gold); }
            50% { filter: brightness(1.4) drop-shadow(0 0 20px gold); }
            100% { filter: brightness(1) drop-shadow(0 0 0px gold); }
        }
        .shining {
            animation: shine 0.8s ease-in-out;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ */
        .shop-item {
            background: #fff0f5;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }
        .shop-item:hover {
            transform: scale(1.02);
            background: #ffe4ee;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–¥–∞–Ω–∏—è */
        .task-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <audio id="sound-coin" src="https://www.soundjay.com/misc/sounds/coins-spilled-1.mp3"></audio>

    <div id="balance-container" class="fq-balance-widget">
        <div class="fq-coin"></div>
        <span id="balance-val">0</span>
    </div>

    <div id="fq-overlay" class="hidden">
        <div id="fq-modal" style="max-width: 750px; width: 95%;">
            <h2 id="modal-title" style="color: #ff4081; margin-top: 0; text-align: center;"></h2>
            
            <div class="game-container">
                <div id="character-preview">
                    <img id="base-body" src="assets/body/girl.png" style="position: absolute; top:0; left:0; width: 100%; z-index: 1;">
                    <img id="layer-bottom" src="" style="position: absolute; top:0; left:0; width: 100%; z-index: 2;">
                    <img id="layer-top" src="" style="position: absolute; top:0; left:0; width: 100%; z-index: 3;">
                    <img id="layer-shoes" src="" style="position: absolute; top:0; left:0; width: 100%; z-index: 4;">
                    <img id="layer-acc" src="" style="position: absolute; top:0; left:0; width: 100%; z-index: 5;">
                </div>

                <div id="modal-content" class="shop-content"></div>
            </div>

            <button id="modal-btn" style="margin-top: 15px; background: #ff4081; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%;">–û–ö</button>
        </div>
    </div>

    <script src="engine.js"></script>
    <script>
        const overlay = document.getElementById('fq-overlay');
        const content = document.getElementById('modal-content');
        const title = document.getElementById('modal-title');
        const btn = document.getElementById('modal-btn');
        const coinSound = document.getElementById('sound-coin');

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–∏—Ñ—Ä—ã –±–∞–ª–∞–Ω—Å–∞
        function refreshBalance() {
            document.getElementById('balance-val').innerText = window.FQ.money;
        }

        window.onload = refreshBalance;

        // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –∫–Ω–æ–ø–æ–∫ –∏–∑ Genially
        window.addEventListener('message', function(event) {
            if (event.data.type === 'openTask') {
                openTask(event.data.q, event.data.a, event.data.m, event.data.img, event.data.shopType);
            }
        });

        // –û–¢–ö–†–´–¢–ò–ï –ó–ê–î–ê–ù–ò–Ø
        function openTask(question, correctAnswer, reward, taskImg, shopType) {
            title.innerText = "–ó–∞–¥–∞–Ω–∏–µ";
            document.getElementById('character-preview').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫—É–∫–ª—É –Ω–∞ –≤—Ä–µ–º—è –≤–æ–ø—Ä–æ—Å–∞
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤ –∑–∞–¥–∞–Ω–∏–∏
            let imgHtml = taskImg ? `<img src="${taskImg}" class="task-image">` : '';
            
            content.innerHTML = `
                ${imgHtml}
                <p style="font-size: 1.1rem; color: #333; text-align:center; font-weight: 500;">${question}</p>
                <input type="text" id="user-answer" style="width:100%; padding:12px; border: 2px solid #ff4081; border-radius: 12px; text-align: center; font-size: 1.1rem;" placeholder="–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å...">
            `;
            overlay.classList.remove('hidden');
            
            btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç";
            btn.onclick = function() {
                const val = document.getElementById('user-answer').value;
                if(val && val.toLowerCase().trim() === correctAnswer.toLowerCase().trim()) {
                    window.FQ.addMoney(reward);
                    refreshBalance();
                    openShop(shopType); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω—É–∂–Ω—ã–π –æ—Ç–¥–µ–ª –º–∞–≥–∞–∑–∏–Ω–∞
                } else {
                    alert("–£–ø—Å! –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!");
                }
            };
        }

        // –û–¢–ö–†–´–¢–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
        function openShop(filterType = 'all') {
            title.innerText = "–í—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É";
            document.getElementById('character-preview').style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É–∫–ª—É
            
            // –¢–í–û–ô –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–ü–ò–°–û–ö –í–ï–©–ï–ô
        const allItems = [
            // –í–ï–†–• (TOP)
            {id: 'top_1', name: '–î–∂–∏–Ω—Å–æ–≤–∫–∞', price: 100, type: 'top'},
            {id: 'top_2', name: '–†–æ–∑–æ–≤–æ–µ —Ö—É–¥–∏', price: 120, type: 'top'},
            {id: 'top_3', name: '–°—Ç–∏–ª—å–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞', price: 80, type: 'top'},
            
            // –ù–ò–ó (BOTTOM)
            {id: 'bottom_1', name: '–î–∂–∏–Ω—Å—ã', price: 150, type: 'bottom'},
            {id: 'bottom_2', name: '–Æ–±–∫–∞', price: 130, type: 'bottom'},
            {id: 'bottom_3', name: '–ë—Ä—é–∫–∏ —á–∏–Ω–æ—Å', price: 140, type: 'bottom'},
            
            // –û–ë–£–í–¨ (SHOES)
            {id: 'shoes_1', name: '–ö–µ–¥—ã', price: 80, type: 'shoes'},
            {id: 'shoes_2', name: '–ë–æ—Ç–∏–Ω–∫–∏', price: 110, type: 'shoes'},
            
            // –ê–ö–°–ï–°–°–£–ê–†–´ (ACC)
            {id: 'acc_1', name: '–°—Ç–∏–ª—å–Ω—ã–µ –æ—á–∫–∏', price: 50, type: 'acc'},
            {id: 'acc_2', name: '–ú–æ–¥–Ω–∞—è —Å—É–º–∫–∞', price: 90, type: 'acc'},
            {id: 'acc_3', name: '–®–ª—è–ø–∞', price: 70, type: 'acc'}
        ];
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–µ—â–∏: –µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª 'top', –ø–æ–∫–∞–∂–µ–º —Ç–æ–ª—å–∫–æ 'top'
            const items = filterType === 'all' ? allItems : allItems.filter(i => i.type === filterType);
            
            let html = `<div>`;
            if (items.length === 0) html += `<p style="text-align:center; color:#888;">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–µ—â–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>`;
            
            items.forEach(item => {
                const isBought = window.FQ.inventory.includes(item.id);
                html += `
                    <div class="shop-item">
                        <span><b>${item.name}</b><br><small>${item.price} üí∞</small></span>
                        <button onclick="tryOn('${item.id}', ${item.price}, '${item.type}')" 
                                style="background: ${isBought ? '#4CAF50' : '#ff4081'}; color: white; border: none; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: bold;">
                            ${isBought ? '–ù–∞–¥–µ—Ç—å' : '–ö—É–ø–∏—Ç—å'}
                        </button>
                    </div>`;
            });
            html += `</div>`;
            
            content.innerHTML = html;
            btn.innerText = "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É";
            btn.onclick = () => {
                overlay.classList.add('hidden');
                window.parent.postMessage({type: 'close'}, '*');
            };
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–†–ò–ú–ï–†–ö–ò / –ü–û–ö–£–ü–ö–ò
        function tryOn(id, price, type) {
            const charPreview = document.getElementById('character-preview');
            
            if (window.FQ.inventory.includes(id)) {
                // –ï—Å–ª–∏ –≤–µ—â—å —É–∂–µ –∫—É–ø–ª–µ–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–µ–≤–∞–µ–º –µ—ë
                applyVisualWear(id, type);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –∫—É–ø–∏—Ç—å
                if (window.FQ.buyItem(id, price)) {
                    coinSound.play(); // –ó–≤—É–∫ –¥–µ–Ω–µ–≥
                    refreshBalance();
                    applyVisualWear(id, type);
                    openShop(window.currentShopType || 'all'); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (—á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–ª–∞ –∑–µ–ª–µ–Ω–æ–π)
                } else {
                    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –†–µ—à–∞–π –±–æ–ª—å—à–µ –∑–∞–¥–∞–Ω–∏–π.");
                }
            }
        }

        // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫—É–∫–ª—É
        function applyVisualWear(id, type) {
            const layer = document.getElementById('layer-' + type);
            const charPreview = document.getElementById('character-preview');
            
            layer.src = 'assets/clothes/' + type + '/' + id + '.png';
            
            // –≠—Ñ—Ñ–µ–∫—Ç —Å–∏—è–Ω–∏—è
            charPreview.classList.add('shining');
            setTimeout(() => charPreview.classList.remove('shining'), 800);
        }
    </script>
</body>
</html>
