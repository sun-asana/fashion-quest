<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fashion Quest Pro Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Ubuntu:wght@400;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root { --p-neon: #00f2ff; --p-grad: linear-gradient(45deg, #00f2ff, #0066ff); --text-color: #1e293b; }
        body { font-family: 'Montserrat', sans-serif; background: #0f172a; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .settings-panel { width: 380px; padding: 25px; background: #1e293b; overflow-y: auto; border-right: 1px solid #334155; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        h2 { color: #38bdf8; font-size: 16px; text-transform: uppercase; margin: 0 0 20px 0; }
        
        .group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 13px; box-sizing: border-box; }
        input::placeholder, textarea::placeholder { color: #475569; }
        
        #drop-zone { border: 2px dashed #334155; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; margin-bottom: 15px; font-size: 12px; color: #64748b; }
        #drop-zone.hover { border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }

        .preview-panel { flex-grow: 1; position: relative; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #preview-bg { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0.4; pointer-events: none; }
        
        #genially-btn-mock { padding: 12px 24px; background: rgba(56, 189, 248, 0.2); border: 1px solid #38bdf8; color: #38bdf8; border-radius: 50px; cursor: pointer; margin-bottom: 40px; font-weight: bold; z-index: 5; }

        #mock-modal { 
            width: 90%; max-width: 500px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px);
            border-radius: 24px; padding: 30px; border: 3px solid var(--p-neon);
            box-shadow: 0 0 30px var(--p-neon); color: var(--text-color); z-index: 5; transition: 0.3s; position: relative;
        }
        .timer-mock { position: absolute; top: 15px; left: 20px; font-size: 12px; }
        .mock-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: 700; margin-top: 20px; cursor: pointer; }

        #copy-btn { width: 100%; padding: 16px; background: #38bdf8; color: #0f172a; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        #copy-btn:hover { background: #7dd3fc; transform: translateY(-2px); }

        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--p-grad); color: white; padding: 12px 25px; border-radius: 50px;
            font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div class="settings-panel">
    <h2>Editor v2.2</h2>

    <div class="group">
        <label>Задание</label>
        <textarea id="q" rows="3" placeholder="Введите текст вопроса или задания..." oninput="updatePreview()"></textarea>
    </div>

    <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        Загрузить картинку задания
        <input type="file" id="file-input" style="display:none" onchange="handleFile(this.files)">
    </div>

    <div class="group"><label>Правильный ответ</label><input type="text" id="a" placeholder="Введите ответ..."></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="group">
            <label>Шрифт</label>
            <select id="fontFamily" onchange="updatePreview()">
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Playfair Display', serif">Playfair</option>
                <option value="'Ubuntu', sans-serif">Ubuntu</option>
                <option value="'Oswald', sans-serif">Oswald</option>
            </select>
        </div>
        <div class="group"><label>Таймер (сек)</label><input type="number" id="time" value="30" oninput="updatePreview()"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="group"><label>Цвет текста</label><input type="color" id="textColor" value="#1e293b" oninput="updatePreview()"></div>
        <div class="group"><label>Цвет неона</label><input type="color" id="neonColor" value="#00f2ff" oninput="updatePreview()"></div>
    </div>

    <div class="group">
        <label>Градиент кнопок</label>
        <select id="btnGradient" onchange="updatePreview()">
            <option value="linear-gradient(45deg, #00f2ff, #0066ff)">Голубой неон</option>
            <option value="linear-gradient(45deg, #ff00ff, #7000ff)">Розовая фуксия</option>
            <option value="linear-gradient(45deg, #facc15, #ea580c)">Огненный</option>
            <option value="linear-gradient(45deg, #4ade80, #166534)">Зеленый лес</option>
        </select>
    </div>

    <div class="group">
        <label>Фон</label>
        <select id="bgImage" onchange="updatePreview()">
            <option value="">Без фона (прозрачный)</option>
            <option value="bg_space">Звездная пыль</option>
            <option value="bg_cyber">Киберпанк</option>
            <option value="bg_watercolor">Акварель</option>
        </select>
    </div>

    <div class="group">
        <label>Категория в магазине</label>
        <select id="shopType">
            <option value="top">Верх</option>
            <option value="bottom">Низ</option>
            <option value="shoes">Обувь</option>
            <option value="hat">Головные уборы</option>
            <option value="acc">Аксессуары</option>
        </select>
    </div>

    <button id="copy-btn" onclick="generateCode()">СКОПИРОВАТЬ КОД</button>
</div>

<div class="preview-panel">
    <div id="preview-bg"></div>
    <div id="genially-btn-mock">✨ Начать задание</div>
    <div id="mock-modal">
        <div class="timer-mock">⏳ Время: <span id="p-time">30</span> сек</div>
        <div id="p-question" style="text-align: center; font-size: 18px; font-weight: 500; margin: 20px 0;">Задание появится здесь...</div>
        <div id="p-img-area" style="display:none; margin-bottom: 15px; text-align: center;"><img id="p-img" style="max-width: 100%; border-radius: 10px; max-height: 150px;"></div>
        <input type="text" placeholder="Введите ответ..." style="text-align: center; border: 1px solid #cbd5e1; background: white; color: #1e293b;">
        <button class="mock-btn">Проверить</button>
    </div>
</div>

<div id="toast">✨ Код скопирован!</div>

<script>
    let uploadedImgBase64 = "";

    function handleFile(files) {
        const file = files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImgBase64 = e.target.result;
            document.getElementById('p-img').src = uploadedImgBase64;
            document.getElementById('p-img-area').style.display = "block";
            document.getElementById('drop-zone').innerText = "Картинка загружена!";
        };
        reader.readAsDataURL(file);
    }

    function updatePreview() {
        const neon = document.getElementById('neonColor').value;
        const txt = document.getElementById('textColor').value;
        const grad = document.getElementById('btnGradient').value;
        const font = document.getElementById('fontFamily').value;
        const bg = document.getElementById('bgImage').value;
        const time = document.getElementById('time').value;

        document.documentElement.style.setProperty('--p-neon', neon);
        document.documentElement.style.setProperty('--p-grad', grad);
        document.documentElement.style.setProperty('--text-color', txt);
        
        const startBtnMock = document.getElementById('genially-btn-mock');
        startBtnMock.style.borderColor = neon;
        startBtnMock.style.color = neon;
        startBtnMock.style.background = `${neon}33`;

        const modal = document.getElementById('mock-modal');
        modal.style.fontFamily = font;
        modal.style.color = txt;
        
        document.getElementById('p-time').innerText = time;
        document.getElementById('p-question').innerText = document.getElementById('q').value || "Задание появится здесь...";
        if (window.MathJax) { MathJax.typeset(); }
        document.querySelector('.mock-btn').style.background = grad;
        
        const bgPanel = document.getElementById('preview-bg');
        bgPanel.style.backgroundImage = bg ? `url('assets/backgrounds/${bg}.png')` : "none";
        bgPanel.style.opacity = bg ? "0.6" : "0";
    }

function generateCode() {
    const data = {
        type: 'openTask',
        q: document.getElementById('q').value,
        a: document.getElementById('a').value,
        img: uploadedImgBase64,
        time: parseInt(document.getElementById('time').value) || 30,
        shopType: document.getElementById('shopType').value,
        fontFamily: document.getElementById('fontFamily').value,
        textColor: document.getElementById('textColor').value,
        neonColor: document.getElementById('neonColor').value,
        btnGradient: document.getElementById('btnGradient').value,
        bgImage: document.getElementById('bgImage').value,
        transparent: document.getElementById('bgImage').value === ""
    };

    const bgUrl = data.bgImage ? `https://raw.githubusercontent.com/sun-asana/fashion-quest/main/assets/backgrounds/${data.bgImage}.png` : "";
    
    // Создаем уникальный ID для каждого задания, чтобы они не конфликтовали
    const uniqueId = 'fq-' + Math.random().toString(36).substr(2, 9);

    const code = `<iframe id="${uniqueId}" 
    src="https://sun-asana.github.io/fashion-quest/index.html" 
    style="width:100%; height:800px; border:none; background:transparent; position:relative; z-index:2;" 
    allowtransparency="true">
</iframe>

<script>
(function() {
    const taskData = ${JSON.stringify(data)};
    const ifr = document.getElementById('${uniqueId}');
    const bg = "${bgUrl}";
    
    function cleanTargetPage() {
        // Ищем только ближайшие родительские элементы именно этого iframe
        let el = ifr;
        while (el && el !== document.body) {
            // Если нашли контейнер слайда Genially
            if (el.classList.contains('genially-view-item')) {
                // Очищаем фон только ЭТОГО слайда
                el.style.backgroundColor = 'transparent';
                el.style.backgroundImage = 'none';
                
                // Если задан наш фон, ставим его только этому слайду
                if (bg) {
                    el.style.background = "url('" + bg + "') center center / cover no-repeat fixed";
                }
                
                // Нашли нужный контейнер — выходим из цикла, дальше (выше) идти не нужно
                break; 
            }
            el = el.parentElement;
        }
    }

    ifr.onload = function() {
        cleanTargetPage();
        setTimeout(() => {
            ifr.contentWindow.postMessage(taskData, '*');
        }, 600);
    };
    
    // Запускаем проверку несколько раз, так как Genially подгружает слои постепенно
    cleanTargetPage();
    setTimeout(cleanTargetPage, 1000);
    setTimeout(cleanTargetPage, 3000);
})();
<\/script>`;

    navigator.clipboard.writeText(code).then(() => {
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    });
}

    const dz = document.getElementById('drop-zone');
    dz.ondragover = () => { dz.classList.add('hover'); return false; };
    dz.ondragleave = () => { dz.classList.remove('hover'); return false; };
    dz.ondrop = (e) => { e.preventDefault(); dz.classList.remove('hover'); handleFile(e.dataTransfer.files); };

    updatePreview();
</script>
</body>
</html>
